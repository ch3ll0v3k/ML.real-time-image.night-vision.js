<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Brain</title>

  <script type="text/javascript" src="./js/browser.js"></script>
  <script type="text/javascript" src="./js/tools.js"></script>

  <style type="text/css">
    #video{ display: none; }
  </style>

  <script type="text/javascript">

    const CamSettings = {
      low: {W:320,H:240},
      mid: {W:640, H:480},
      hight: {W:800, H:600},
      ultra: {W:1280, H:720},
    };

    let Net = null;
    let timeout_t = null;
    let FPS = 1000/60;
    let video = null;
    let canvas = null;
    let ctx = null;

    const SUBSET = 30;
    const TRS_HOLD = 250;

    const { W, H } = CamSettings.mid;

    window.addEventListener('load', async()=>{

      const network_t = await loadJSONFromURL(`brain.SUBSET.${SUBSET}.json`);

      // NeuralNetworkGPU : GPU
      // NeuralNetwork    : CPU
      Net = new brain.NeuralNetwork({
        inputSize: 2,
        hiddenLayers: [],
        outputSize: 2,
        activation: 'sigmoid',
      });

      // load pre-trained network
      Net.fromJSON( network_t );
      console.log(' done ...');

      video = document.getElementById('video');
      video.setAttribute('width', W);
      video.setAttribute('height', H);

      canvas = document.getElementById('canvas');
      canvas.setAttribute('width', W*2);
      canvas.setAttribute('height', H);

      ctx = canvas.getContext('2d');

      if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        // Not adding `{ audio: true }` since we only want video now
        navigator.mediaDevices.getUserMedia({ video: true }).then(function(stream) {
          //video.src = window.URL.createObjectURL(stream);
          video.srcObject = stream;
          video.play();
        });
      }

      loop();

    });

    function loop(){

      clearTimeout(timeout_t);

      ctx.drawImage(video, 0, 0, W, H);

      const raw_RGBA = ctx.getImageData(0, 0, W, H);

      const SUBSET_MUL = 4; // R,G,B,A

      for( let y=0; y<H; y++ ){
        for( let x=0; x<( W * SUBSET_MUL ); x+=(SUBSET *SUBSET_MUL) ){

          let input_subset = [];

          const X = (y *(W*SUBSET_MUL))+x;

          for( let sub_x=X, index = 0; sub_x<(X+(SUBSET * SUBSET_MUL)); sub_x += (SUBSET_MUL), index++ ){

            const R = raw_RGBA.data[ sub_x +0 ];
            const G = raw_RGBA.data[ sub_x +1 ];
            const B = raw_RGBA.data[ sub_x +2 ];
            // const A = raw_RGBA.data[ sub_x +x +3 ];
            input_subset.push( (R+G+B) /3 /255 );
          }

          // Predict ...
          const netRes = Net.run( input_subset );

          for( let sub_x=X, index = 0; sub_x<(X+(SUBSET * SUBSET_MUL)); sub_x += (SUBSET_MUL), index++ ){

            const V = Math.floor( netRes[ index ] * 255 );

            // Adjust pixels ...
            raw_RGBA.data[ sub_x +0 ] = V;
            raw_RGBA.data[ sub_x +1 ] = V;
            raw_RGBA.data[ sub_x +2 ] = V;
            raw_RGBA.data[ sub_x +3 ] = 255;

          }

        }

      }

      ctx.putImageData(raw_RGBA, W+5, 0);
      timeout_t = setTimeout(()=>{ loop(); }, FPS);

    };

  </script>

</head>
<body>

  <video id="video" width="800" height="600" autoplay></video>
  <canvas id="canvas" width="1600" height="600"></canvas>

</body>
</html>